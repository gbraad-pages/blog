<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>non-root user inside a Docker container - Gerard Braad's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://gbraad.nl/blog/non-root-user-inside-a-docker-container.html">

        <meta name="author" content="Gerard Braad <me@gbraad.nl>" />
        <meta name="keywords" content="docker,fedora" />
        <meta name="description" content="One of the things that you notice when using Docker, is that all commands you run from the Dockerfile with RUN or CMD are performed as the root user. This is not only a bad security practice for running internet facing services, it might even prevent certain applications from working ..." />

        <meta property="og:site_name" content="Gerard Braad's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="non-root user inside a Docker container"/>
        <meta property="og:url" content="http://gbraad.nl/blog/non-root-user-inside-a-docker-container.html"/>
        <meta property="og:description" content="One of the things that you notice when using Docker, is that all commands you run from the Dockerfile with RUN or CMD are performed as the root user. This is not only a bad security practice for running internet facing services, it might even prevent certain applications from working ..."/>
        <meta property="article:published_time" content="2016-09-08" />
            <meta property="article:section" content="Containers" />
            <meta property="article:tag" content="docker" />
            <meta property="article:tag" content="fedora" />
            <meta property="article:author" content="Gerard Braad <me@gbraad.nl>" />


    <!-- Bootstrap -->
	<link href="//cdn.gbraad.nl/css/bootstrap.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/font-awesome.css" rel="stylesheet">
    <link href="//cdn.gbraad.nl/css/pygments-tomorrownightbright.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/animations.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/style.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/custom.css" rel="stylesheet">

        <link href="http://gbraad.nl/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gerard Braad's blog ATOM Feed"/>



        <link href="http://gbraad.nl/blog/feeds/containers.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gerard Braad's blog Containers ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://gbraad.nl/blog/" class="navbar-brand">
Gerard Braad's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://gbraad.nl/blog/category/about-me.html">About me</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/books.html">Books</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/ci-cd.html">CI / CD</a>
                        </li>
                        <li class="active">
                            <a href="http://gbraad.nl/blog/category/containers.html">Containers</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/devops.html">DevOps</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/high-availability.html">High Availability</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/javascript.html">JavaScript</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/openstack.html">OpenStack</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://gbraad.nl/blog/non-root-user-inside-a-docker-container.html"
                       rel="bookmark"
                       title="Permalink to non-root user inside a Docker container">
                        non-root user inside a Docker container
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-09-08T00:00:00+08:00"> Thu 08 September 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://gbraad.nl/blog/tag/docker.html">docker</a>
        /
	<a href="http://gbraad.nl/blog/tag/fedora.html">fedora</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>One of the things that you notice when using Docker, is that all commands you run from the <code>Dockerfile</code> with <code>RUN</code> or <code>CMD</code> are performed as the <code>root</code> user. This is not only a bad security practice for running internet facing services, it might even prevent certain applications from working properly. So, how do you run commands as a non-root user? For people using Red Hat-based systems, such as Fedora or CentOS I will explain how you can do this.</p>
<h2>Let's begin</h2>
<p>Let's say you have a <code>Dockerfile</code> using Fedora as a base:</p>
<div class="highlight"><pre><span></span>FROM fedora:24
</pre></div>


<h2>Create user</h2>
<p>Before we can use a different user, we need to create one:</p>
<div class="highlight"><pre><span></span>RUN adduser user
</pre></div>


<h2>Run as user</h2>
<p>Now you can run commands as this user by doing:</p>
<div class="highlight"><pre><span></span>RUN su - user -c &quot;touch me&quot;
</pre></div>


<p>The container start process can be changed to:</p>
<div class="highlight"><pre><span></span>CMD [&quot;su&quot;, &quot;-&quot;, &quot;user&quot;, &quot;-c&quot;, &quot;/bin/bash&quot;]
</pre></div>


<p>This way, a <code>bash</code> shell will open as the user.</p>
<h2>Allow <code>sudo</code> usage</h2>
<p>Since you are running a normal user, it might be handy to install the following package inside the container:</p>
<div class="highlight"><pre><span></span>RUN dnf install -y sudo
</pre></div>


<p>This will allow you to use <code>sudo</code> to perform actions as the root user:</p>
<div class="highlight"><pre><span></span>RUN echo &quot;user ALL=(root) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/user &amp;&amp; \
    chmod 0440 /etc/sudoers.d/user
</pre></div>


<h2>Final <code>Dockerfile</code></h2>
<p>To combine all of this, your <code>Dockerfile</code> would look as follows:</p>
<p><code>Dockerfile</code></p>
<div class="highlight"><pre><span></span>FROM fedora:24

RUN dnf install -y sudo &amp;&amp; \
    adduser user &amp;&amp; \
    echo &quot;user ALL=(root) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/user &amp;&amp; \
    chmod 0440 /etc/sudoers.d/user

RUN su - user -c &quot;touch mine&quot;

CMD [&quot;su&quot;, &quot;-&quot;, &quot;user&quot;, &quot;-c&quot;, &quot;/bin/bash&quot;]
</pre></div>


<h2>Result</h2>
<p>Building this container is simple:</p>
<div class="highlight"><pre><span></span>$ docker build -t user .
Step 1 : FROM fedora:24
 ---&gt; f9873d530588
Step 2 : RUN dnf install -y sudo &amp;&amp;     adduser user &amp;&amp;     echo &quot;user ALL=(root) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/user &amp;&amp;     chmod 0440 /etc/sudoers.d/user
 ---&gt; Using cache
 ---&gt; 05c3f3c7e9fc
Step 3 : RUN su - user -c &quot;touch me&quot;
 ---&gt; Running in 584ab0ad025b
 ---&gt; 66ea558b9855
Removing intermediate container 584ab0ad025b
Step 4 : CMD su - user -c /bin/bash
 ---&gt; Running in 780e0ccd5f61
 ---&gt; b19a10012b28
Removing intermediate container 780e0ccd5f61
Successfully built b19a10012b28
</pre></div>


<p>Running it will produce the following result:</p>
<div class="highlight"><pre><span></span><span class="err">$ </span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">rm</span> <span class="n">user</span>
<span class="p">[</span><span class="n">user</span><span class="mi">@48</span><span class="n">add6313ab6</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">al</span>
<span class="n">total</span> <span class="mi">20</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">user</span> <span class="n">user</span> <span class="mi">4096</span> <span class="n">Sep</span>  <span class="mi">8</span> <span class="mi">08</span><span class="o">:</span><span class="mi">51</span> <span class="p">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Sep</span>  <span class="mi">8</span> <span class="mi">08</span><span class="o">:</span><span class="mi">46</span> <span class="p">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">4</span> <span class="n">user</span> <span class="n">user</span>   <span class="mi">18</span> <span class="n">May</span> <span class="mi">17</span> <span class="mi">14</span><span class="o">:</span><span class="mi">22</span> <span class="p">.</span><span class="n">bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">4</span> <span class="n">user</span> <span class="n">user</span>  <span class="mi">193</span> <span class="n">May</span> <span class="mi">17</span> <span class="mi">14</span><span class="o">:</span><span class="mi">22</span> <span class="p">.</span><span class="n">bash_profile</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">4</span> <span class="n">user</span> <span class="n">user</span>  <span class="mi">231</span> <span class="n">May</span> <span class="mi">17</span> <span class="mi">14</span><span class="o">:</span><span class="mi">22</span> <span class="p">.</span><span class="n">bashrc</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">user</span> <span class="n">user</span>    <span class="mi">0</span> <span class="n">Sep</span>  <span class="mi">8</span> <span class="mi">08</span><span class="o">:</span><span class="mi">51</span> <span class="n">me</span>
<span class="p">[</span><span class="n">user</span><span class="mi">@48</span><span class="n">add6313ab6</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">pwd</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span>
<span class="p">[</span><span class="n">user</span><span class="mi">@48</span><span class="n">add6313ab6</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> 
</pre></div>


<h2>Base images</h2>
<p>If you are setting up base images for re-use, it can be handy to use the <code>USER</code> keyword. This will run all the following commqnds as a particalur. Lets say, you want to use a service, which is Node.JS based, you can create the following <code>Dockerfile</code></p>
<div class="highlight"><pre><span></span>FROM centos:7
MAINTAINER Gerard Braad &lt;me@gbraad.nl&gt;

# Run update and install dependencies
RUN yum update -y &amp;&amp; yum install -y nodejs npm

# Add the user UID:1000, GID:1000, home at /app
RUN groupadd -r app -g 1000 &amp;&amp; useradd -u 1000 -r -g app -m -d /app -s /sbin/nologin -c &quot;App user&quot; app &amp;&amp; \
    chmod 755 /app

# Set the working directory to app home directory
WORKDIR /app

# Specify the user to execute all commands below
USER app
</pre></div>


<p>You can then use this container as a base for NodeJS based applications. You copy the application to <code>/app</code> and when commands are run, they will use the user named <code>user</code>.</p>
<p>I hope this has been of some help to you. You can <a href="https://twitter.com/gbraad">follow me</a> on Twitter or leave a comment below.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'gbraad-blog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'non-root-user-inside-a-docker-container';
                var disqus_url = 'http://gbraad.nl/blog/non-root-user-inside-a-docker-container.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Gerard Braad <me@gbraad.nl>
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://gbraad.nl/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://gbraad.nl/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://gbraad.nl/blog/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'gbraad-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-34531495-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>