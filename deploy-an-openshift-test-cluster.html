<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Deploy an OpenShift test cluster - Gerard Braad's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://gbraad.nl/blog/deploy-an-openshift-test-cluster.html">

        <meta name="author" content="Gerard Braad <me@gbraad.nl>" />
        <meta name="keywords" content="openshift,kubernetes,containers,docker" />
        <meta name="description" content="In my previous article I described how I used an Ansible playbook and a few roles to stand-up a Kubernetes test environment. In that article I mentioned that to deploy a production-ready environment some work more was required. Luckily, it is now very easy to stand up a production and ..." />

        <meta property="og:site_name" content="Gerard Braad's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Deploy an OpenShift test cluster"/>
        <meta property="og:url" content="http://gbraad.nl/blog/deploy-an-openshift-test-cluster.html"/>
        <meta property="og:description" content="In my previous article I described how I used an Ansible playbook and a few roles to stand-up a Kubernetes test environment. In that article I mentioned that to deploy a production-ready environment some work more was required. Luckily, it is now very easy to stand up a production and ..."/>
        <meta property="article:published_time" content="2016-09-27" />
            <meta property="article:section" content="Containers" />
            <meta property="article:tag" content="openshift" />
            <meta property="article:tag" content="kubernetes" />
            <meta property="article:tag" content="containers" />
            <meta property="article:tag" content="docker" />
            <meta property="article:author" content="Gerard Braad <me@gbraad.nl>" />


    <!-- Bootstrap -->
	<link href="//cdn.gbraad.nl/css/bootstrap.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/font-awesome.css" rel="stylesheet">
    <link href="//cdn.gbraad.nl/css/pygments-tomorrownightbright.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/animations.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/style.css" rel="stylesheet">
	<link href="//cdn.gbraad.nl/css/custom.css" rel="stylesheet">

        <link href="http://gbraad.nl/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gerard Braad's blog ATOM Feed"/>



        <link href="http://gbraad.nl/blog/feeds/containers.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gerard Braad's blog Containers ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://gbraad.nl/blog/" class="navbar-brand">
Gerard Braad's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://gbraad.nl/blog/category/about-me.html">About me</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/books.html">Books</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/ci-cd.html">CI / CD</a>
                        </li>
                        <li class="active">
                            <a href="http://gbraad.nl/blog/category/containers.html">Containers</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/devops.html">DevOps</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/high-availability.html">High Availability</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/javascript.html">JavaScript</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://gbraad.nl/blog/category/openstack.html">OpenStack</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://gbraad.nl/blog/deploy-an-openshift-test-cluster.html"
                       rel="bookmark"
                       title="Permalink to Deploy an OpenShift test cluster">
                        Deploy an OpenShift test cluster
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-09-27T00:00:00+08:00"> Tue 27 September 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://gbraad.nl/blog/tag/openshift.html">openshift</a>
        /
	<a href="http://gbraad.nl/blog/tag/kubernetes.html">kubernetes</a>
        /
	<a href="http://gbraad.nl/blog/tag/containers.html">containers</a>
        /
	<a href="http://gbraad.nl/blog/tag/docker.html">docker</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In my previous article I described how I used an Ansible playbook and a few roles
to stand-up a Kubernetes test environment. In that article I mentioned that to
deploy a production-ready environment some work more was required. Luckily, it
is now very easy to stand up a production and enterprise-ready container
platform for hosting applications, called <a href="https://www.openshift.com">OpenShift</a>.
Through the years OpenShift has undergone a lot of changes, and the latest
version Origin v1.3 is very different from the original version. OpenShift sets
up a complete Kubernetes environment and with a set of tools it can take care of
the whole application lifecycle, from source to deployment. In this article I
will give an introduction to setting up a test environment for a developer.</p>
<h2>Setup machine</h2>
<p>I will setup the environment on a standard Fedora 24 installation. You can use a
cloud image as all the needed packages will be specified. After installing the
machine, you login as a standard user, which can do a password-less sudo.</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ssh</span> <span class="n">fedora</span><span class="mf">@89.42.141.96</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span>
<span class="cp">#</span>
</pre></div>


<h3>Install docker and client</h3>
<p>From here all the commands will be run as root, unless otherwise specified.</p>
<div class="highlight"><pre><span></span>$ dnf install -y docker curl
</pre></div>


<p>This will install the basic packages we need to setup the test cluster. Now from
a browser you open the following page: <a href="https://github.com/openshift/origin/releases/tag/v1.3.0">https://github.com/openshift/origin/releases/tag/v1.3.0</a>.
This shows the current deliverables for the OpenShift Origin v1.3 release. You
need to download the file called like <code>openshift-origin-client-tools-v1.3.0-[...]-linux-64bit.tar.gz</code></p>
<div class="highlight"><pre><span></span>$ curl -sSL https://github.com/openshift/origin/releases/download/v1.3.0/openshift-origin-client-tools-v1.3.0-3ab7af3d097b57f933eccef684a714f2368804e7-linux-64bit.tar.gz -o oc-client.tar.gz
$ tar -zxvf oc-client.tar.gz
$ mkdir -p /opt/openshift/client
$ cp ./openshift-origin-client-tools-v1.3.0-3ab7af3d097b57f933eccef684a714f2368804e7-linux-64bit/oc /opt/openshift/client/oc
</pre></div>


<p>Note: I do not install the binary in <code>/usr/bin</code> or <code>/usr/sbin</code> to prevent a
conflict with a packaged version, but also because this makes it easier for me
to work on a different version of the application. E.g. the current packaged
version is v1.2 and does not provide the command we will be using in the next
step.</p>
<h3>Configure docker</h3>
<p>To allow OpenShift to pull and locally cache images, it will deploy a local
docker registry. But before docker would be able to use this, we need to
specify an insecure registry in the configuration. For this you need to add
<code>--insecure-registry 172.30.0.0/16</code> to <code>/etc/sysconfig/docker</code>.</p>
<div class="highlight"><pre><span></span>$ vi /etc/sysconfig/docker
</pre></div>


<div class="highlight"><pre><span></span>OPTIONS=&#39;--selinux-enabled --log-driver=journald --insecure-registry 172.30.0.0/16&#39;
</pre></div>


<p>After this we will setup to allow the standard user to communicate with the
docker daemon over the docker socket. This is not a necessary step, and does not
make the system more secure. It does make it easier not having to move between
user and using sudo all the time.</p>
<div class="highlight"><pre><span></span>$ groupadd docker
$ usermod -a -G docker fedora
$ chgrp docker /var/run/docker.sock
</pre></div>


<p>Edit: I recently created an <a href="https://github.com/gbraad/ansible-playbooks/blob/master/playbooks/enable-ansible-user-for-docker.yml">Ansible playbook</a>
to perform these steps, as I had to do this on several Atomic hosts. I uses the
current Ansible user and adds it to a group, and changes the socket permissions.</p>
<p>After this you can start docker and move on the actual installation of OpenShift.</p>
<div class="highlight"><pre><span></span>$ systemctl <span class="nb">enable</span> docker
$ systemctl start docker
</pre></div>


<p>Note: we will be running this environment with devicemapper as Storage Driver.
This is not an ideal situation. If you do further tests, consider changing the
storage with <code>docker-storage-setup</code> to use a dedicated volume.</p>
<h2>Running OpenShift</h2>
<p>Since version 1.3 of OpenShift, the client provides a <code>cluster up</code> commands
which stands up a very simple all-in-one cluster, with a configured registry,
router, image streams, and default templates.</p>
<p>As the fedora user, you can check if you can access docker</p>
<div class="highlight"><pre><span></span>$ docker ps
</pre></div>


<div class="highlight"><pre><span></span>CONTAINER ID    IMAGE   COMMAND     CREATED     STATUS      PORTS   NAMES
</pre></div>


<p>No containers should be returned. This mean you can communicate with the docker
daemon. Now you are ready to start the test cluster. </p>
<h3><code>cluster up</code></h3>
<div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/openshift/client/
$ ./oc cluster up
-- Checking OpenShift client ... OK
-- Checking Docker client ... OK
-- Checking Docker version ... OK
-- Checking <span class="k">for</span> existing OpenShift container ... OK
-- Checking <span class="k">for</span> openshift/origin:v1.3.0 image ... OK
-- Checking Docker daemon configuration ... OK
-- Checking <span class="k">for</span> available ports ... OK
-- Checking <span class="nb">type</span> of volume mount ... 
   Using nsenter mounter <span class="k">for</span> OpenShift volumes
-- Creating host directories ... OK
-- Finding server IP ... 
   Using 10.5.0.27 as the server IP
-- Starting OpenShift container ... 
   Creating initial OpenShift configuration
   Starting OpenShift using container <span class="s1">&#39;origin&#39;</span>
   Waiting <span class="k">for</span> API server to start listening
   OpenShift server started
-- Installing registry ... OK
-- Installing router ... OK
-- Importing image streams ... OK
-- Importing templates ... OK
-- Login to server ... OK
-- Creating initial project <span class="s2">&quot;myproject&quot;</span> ... OK
-- Server Information ... 
   OpenShift server started.
   The server is accessible via web console at:
       https://10.5.0.27:8443

   You are logged in as:
       User:     developer
       Password: developer

   To login as administrator:
       oc login -u system:admin
</pre></div>


<p>And that was it! Now you are running an OpenShift environment. You can check
this as follows:</p>
<div class="highlight"><pre><span></span>$ docker ps
</pre></div>


<div class="highlight"><pre><span></span>CONTAINER ID        IMAGE                                     COMMAND                  CREATED             STATUS              PORTS               NAMES
cebba70022a6        openshift/origin-haproxy-router:v1.3.0    &quot;/usr/bin/openshift-r&quot;   16 seconds ago      Up 15 seconds                           k8s_router.9426645a_router-1-o3454_default_ba2e0814-8483-11e6-924a-fa163e29da46_e9a13a8d
32aa5e84a04d        openshift/origin-docker-registry:v1.3.0   &quot;/bin/sh -c &#39;DOCKER_R&quot;   17 seconds ago      Up 15 seconds                           k8s_registry.f0a205a4_docker-registry-1-v57os_default_b9fc0130-8483-11e6-924a-fa163e29da46_24863324
03ee38d125cb        openshift/origin-pod:v1.3.0               &quot;/pod&quot;                   18 seconds ago      Up 16 seconds                           k8s_POD.4a82dc9f_router-1-o3454_default_ba2e0814-8483-11e6-924a-fa163e29da46_ea6d1d08
44d6f8d2d9d6        openshift/origin-pod:v1.3.0               &quot;/pod&quot;                   18 seconds ago      Up 16 seconds                           k8s_POD.9fa2fe82_docker-registry-1-v57os_default_b9fc0130-8483-11e6-924a-fa163e29da46_76754271
60e7cc5f4e5d        openshift/origin-deployer:v1.3.0          &quot;/usr/bin/openshift-d&quot;   21 seconds ago      Up 19 seconds                           k8s_deployment.59c7ba3f_router-1-deploy_default_b3660c7b-8483-11e6-924a-fa163e29da46_8e02f47a
f1fe993ddcac        openshift/origin-pod:v1.3.0               &quot;/pod&quot;                   22 seconds ago      Up 20 seconds                           k8s_POD.4a82dc9f_router-1-deploy_default_b3660c7b-8483-11e6-924a-fa163e29da46_9a38fe5e
72068a244ac8        openshift/origin:v1.3.0                   &quot;/usr/bin/openshift s&quot;   49 seconds ago      Up 48 seconds                           origin
</pre></div>


<h3>Client connection</h3>
<p>After running the command <code>oc cluster up</code> you will be automatically logged in.
For this it writes the login configuration in <code>~/.kube/</code>. If you want to change
you can login using:</p>
<div class="highlight"><pre><span></span>$ oc login
</pre></div>


<p>The standard user provided is <code>developer</code>.</p>
<h3>Verify</h3>
<p>Now we need to verify if we can deploy a simple application. However, without
changes, OpenShift will not run containers with a root-user process. For example
an nginx container would fail with a <code>permission denied</code> error.</p>
<p>Instead, we will for now run a simple Hello container:</p>
<div class="highlight"><pre><span></span>$ oc run hello-openshift --image<span class="o">=</span>docker.io/openshift/hello-openshift:latest --port<span class="o">=</span><span class="m">8080</span> --expose
</pre></div>


<div class="highlight"><pre><span></span>service &quot;hello-openshift&quot; created
deploymentconfig &quot;hello-openshift&quot; created
</pre></div>


<p>This would create the container and schedule it. You can check the progress with:</p>
<div class="highlight"><pre><span></span>$ oc get pod
</pre></div>


<div class="highlight"><pre><span></span>NAME                        READY     STATUS    RESTARTS   AGE
hello-openshift-1-xi7f0     1/1       Running   0          9m
</pre></div>


<p>You will also see a <code>-deploy</code> container. This is not needed for our verification.</p>
<p>To check the application, we need to get the IP address that has been assigned
to the Pod. You can do this as follows:</p>
<div class="highlight"><pre><span></span>$ oc get pod hello-openshift-1-xi7f0 -o yaml <span class="p">|</span> grep podIP
</pre></div>


<div class="highlight"><pre><span></span>  podIP: 172.17.0.7
</pre></div>


<p>All you have to do now is open the endpoint:</p>
<div class="highlight"><pre><span></span>$ curl 172.17.0.7:8080
</pre></div>


<div class="highlight"><pre><span></span>Hello OpenShift!
</pre></div>


<p>And that is it, you have a working OpenShift test cluster.</p>
<h3>Teardown</h3>
<p>If you are down with this, you simply do a:</p>
<div class="highlight"><pre><span></span>$ oc cluster down
</pre></div>


<p>and all the containers used in the deployment will be torn down.</p>
<h2>Conclusion</h2>
<p>Using OpenShift's <code>cluster up</code> command you can easily setup an environment for
developers to run and test their applications. The current of OpenShift
provided with Fedora 24 does not offer this command, as the packaged version is
v1.2. However, this change is in Rawhide and is therefore expected to be
released as part of Fedora 25.</p>
<p>In future articles I will detail more about how to create applications for the
OpenShift container platform, and how to check and maintain the life cycle of
the deployed application. For now, take a look at the other source of
information below.</p>
<h2>More information</h2>
<ul>
<li>OpenShift <a href="https://www.openshift.com/">Homepage</a></li>
<li><a href="https://github.com/openshift/origin">OpenShift Origin</a> at GitHub</li>
<li>Knowledge-base article about <a href="https://gitlab.com/gbraad/knowledge-base/blob/master/technology/openshift.md">OpenShift</a></li>
</ul>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'gbraad-blog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'deploy-an-openshift-test-cluster';
                var disqus_url = 'http://gbraad.nl/blog/deploy-an-openshift-test-cluster.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Gerard Braad <me@gbraad.nl>
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://gbraad.nl/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://gbraad.nl/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://gbraad.nl/blog/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'gbraad-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-34531495-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>